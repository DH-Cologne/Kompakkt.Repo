<form class="metadata-container" [formGroup]="entity">
    <h1 *ngIf="!isPhysical">Digital Object Metadata Form</h1>

    <div class="metadata-nested">
        <mat-form-field>
            <input required matInput placeholder="Title" formControlName="title">
        </mat-form-field>

        <mat-form-field>
      <textarea required matInput
                cdkTextareaAutosize
                placeholder="Description" formControlName="description"></textarea>
        </mat-form-field>

        <ng-container *ngIf="!isPhysical">
            <mat-form-field>
                <input matInput placeholder="Add new or search existing tag" [matAutocomplete]="tagAuto" (keydown)="addTag($event)">
            </mat-form-field>
            <mat-autocomplete #tagAuto="matAutocomplete" (optionSelected)="tagSelected($event)">
                <mat-option *ngFor="let tag of content.getTags()" [value]="tag">
                    {{ tag.value }}
                </mat-option>
            </mat-autocomplete>
            <mat-chip-list formArrayName="tags">
                <mat-chip (click)="removeTag(i)" *ngFor="let tag of tags.controls; index as i">{{
                    tag.value.value
                    }}</mat-chip>
            </mat-chip-list>

            <mat-form-field>
                <input matInput placeholder="Objecttype" formControlName="objecttype">
            </mat-form-field>

            <mat-form-field>
                <input matInput placeholder="Statement" formControlName="statement">
            </mat-form-field>
        </ng-container>
    </div>

    <!-- Fields specific to Digital Entity -->
    <ng-container *ngIf="!isPhysical">

        <div class="metadata-nested">

            <h2>Licence</h2>
            <mat-radio-group class="radio-group">
                <ng-container *ngFor="let licence of availableLicences">
                    <mat-radio-button class="radio-button"
                                      (change)="updateLicence($event)"
                                      [value]="licence.title" [checked]="licence.title === selectedLicence">
                        <img src="assets/licence/{{licence.title}}.png" alt="Licence: {{licence.title}}"
                             class="licence-icon">
                    </mat-radio-button>
                    <!--
                    <div class="licence-description">
                        <a href="{{licence.link}}" target="_blank">
                            (more)
                        </a>
                    </div>
                    -->
                </ng-container>
            </mat-radio-group>
        </div>

        <div class="metadata-nested" formArrayName="discipline">
            <h2>Discipline</h2>
            <mat-form-field>
                <input required matInput placeholder="Add a new discipline" (keydown)="addDiscipline($event)">
            </mat-form-field>
            <mat-chip-list>
                <mat-chip (click)="removeDiscipline(i)"
                          *ngFor="let discipline of discipline.controls; index as i">{{
                    discipline.value
                    }}</mat-chip>
            </mat-chip-list>
        </div>

        <div class="metadata-nested" formArrayName="dimensions">
            <h2>Dimensions</h2>

            <mat-tab-group>
                <mat-tab *ngFor="let dimension of dimensions.controls; index as i;" [formGroup]="dimension">
                    <ng-template mat-tab-label>
                        <p>{{ getTabLabel(dimension.value.name, 'dimension') }}</p>
                        <button class="metadata-tab-delete-button" mat-button color="warn"
                                (click)="removeDimension(i)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </ng-template>

                    <mat-form-field>
                        <input required matInput placeholder="Name" formControlName="name">
                    </mat-form-field>
                    <mat-form-field>
                        <input required matInput placeholder="Type" formControlName="type">
                    </mat-form-field>
                    <mat-form-field>
                        <input required matInput placeholder="Value" formControlName="value">
                    </mat-form-field>
                </mat-tab>
            </mat-tab-group>

            <button (click)="addDimension()"
                    color="primary"
                    mat-button>
                <mat-icon>add_circle</mat-icon>
                Add dimensions entry
            </button>
        </div>

        <div class="metadata-nested" formArrayName="creation">
            <h2>Creation</h2>

            <mat-tab-group>
                <mat-tab *ngFor="let creation of creation.controls; index as i;" [formGroup]="creation">
                    <ng-template mat-tab-label>
                        <p>{{ getTabLabel(creation.value.technique, 'creation') }}</p>
                        <button class="metadata-tab-delete-button" mat-button color="warn"
                                (click)="removeCreation(i)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </ng-template>

                    <mat-form-field>
                        <input required matInput placeholder="Technique" formControlName="technique">
                    </mat-form-field>
                    <mat-form-field>
                        <input required matInput placeholder="Program" formControlName="program">
                    </mat-form-field>
                    <mat-form-field>
                        <input matInput placeholder="Equipment" formControlName="equipment">
                    </mat-form-field>
                    <mat-form-field>
                        <input matInput placeholder="Date" formControlName="date">
                    </mat-form-field>
                </mat-tab>
            </mat-tab-group>

            <button (click)="addCreation()"
                    mat-button
                    color="primary">
                <mat-icon>add_circle</mat-icon>
                Add creation entry
            </button>
        </div>
    </ng-container>

    <!-- Fields specific to Physical Entity -->
    <ng-container *ngIf="isPhysical">
        <div class="metadata-nested">
            <mat-form-field>
                <input matInput placeholder="Collection" formControlName="collection">
            </mat-form-field>
        </div>

        <div class="metadata-nested" [formGroup]="place">
            <h2>Place</h2>
            <mat-form-field>
                <input matInput placeholder="Place name" formControlName="name">
            </mat-form-field>
            <mat-form-field>
                <input matInput placeholder="Place geopolitical area" formControlName="geopolarea">
            </mat-form-field>
            <app-address [(address)]="placeAddress"></app-address>
        </div>
    </ng-container>
    <!-- End of specific fields -->

    <div class="metadata-nested" formArrayName="persons">
        <h2>Persons</h2>

        <mat-form-field>
            <input #personInput matInput placeholder="Search for a person" [matAutocomplete]="personAuto">
        </mat-form-field>
        <mat-autocomplete #personAuto="matAutocomplete" (optionSelected)="personSelected($event, personInput)">
            <mat-option *ngFor="let person of autocompletePersons" [value]="person">
                {{ getPersonName(person) }}
            </mat-option>
        </mat-autocomplete>
        <mat-tab-group>
            <mat-tab *ngFor="let person of persons.controls; index as i;" [formGroup]="person">
                <ng-template mat-tab-label>
                    <p>{{ (person.value.name + person.value.prename).length > 0 ? person.value.prename + ' ' + person.value.name : 'New Person' }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn" (click)="removePerson(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>
                <app-person [preview]="true" [(person)]="person" [relatedEntityId]="_id.value"></app-person>
            </mat-tab>
        </mat-tab-group>
        <button (click)="addPerson()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add person
        </button>
    </div>

    <div class="metadata-nested" formArrayName="institutions">
        <h2>Institutions</h2>

        <mat-form-field>
            <input #institutionInput matInput placeholder="Search for an institution" [matAutocomplete]="institutionAuto">
        </mat-form-field>
        <mat-autocomplete #institutionAuto="matAutocomplete" (optionSelected)="institutionSelected($event, institutionInput)">
            <mat-option *ngFor="let institution of autocompleteInstitutions" [value]="institution">
                {{ institution.name.value ? institution.name.value : institution.name }}
            </mat-option>
        </mat-autocomplete>
        <mat-tab-group>
            <mat-tab *ngFor="let institution of institutions.controls; index as i;" [formGroup]="institution">
                <ng-template mat-tab-label>
                    <p>{{ getTabLabel(institution.value.name, 'institution') }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn"
                            (click)="removeInstitution(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>
                <app-institution [preview]="true" [(institution)]="institution" [relatedEntityId]="_id.value"></app-institution>
            </mat-tab>
        </mat-tab-group>
        <button (click)="addInstitution()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add institution
        </button>
    </div>

    <div class="metadata-nested" formArrayName="externalId">
        <h2>External Identifiers</h2>

        <mat-tab-group>
            <mat-tab *ngFor="let externalId of externalId.controls; index as i" [formGroup]="externalId">
                <ng-template mat-tab-label>
                    <p>{{ getTabLabel(externalId.value.type, 'external identifier') }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn"
                            (click)="removeExternalId(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>

                <mat-form-field>
                    <input required matInput placeholder="Type" formControlName="type">
                </mat-form-field>
                <mat-form-field>
                    <input required matInput placeholder="Value" formControlName="value">
                </mat-form-field>
            </mat-tab>
        </mat-tab-group>

        <button (click)="addExternalId()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add an external identifier
        </button>
    </div>

    <div class="metadata-nested" formArrayName="externalLink">
        <h2>External Links</h2>

        <mat-tab-group>
            <mat-tab *ngFor="let externalLink of externalLink.controls; index as i" [formGroup]="externalLink">
                <ng-template mat-tab-label>
                    <p>{{ getTabLabel(externalLink.value.description, 'external link') }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn"
                            (click)="removeExternalLink(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>

                <mat-form-field>
                    <input matHint="What kind of link is this?" required matInput placeholder="Description"
                           formControlName="description">
                </mat-form-field>
                <mat-form-field>
                    <input required matInput placeholder="Value" formControlName="value">
                </mat-form-field>
            </mat-tab>
        </mat-tab-group>

        <button (click)="addExternalLink()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add an external link
        </button>
    </div>

    <div class="metadata-nested" formArrayName="biblioRefs">
        <h2>Bibliographic references</h2>

        <mat-tab-group>
            <mat-tab *ngFor="let biblioRef of biblioRefs.controls; index as i" [formGroup]="biblioRef">
                <ng-template mat-tab-label>
                    <p>{{ getTabLabel(biblioRef.value.description, 'bibliographic reference') }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn"
                            (click)="removeBiblioRef(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>

                <mat-form-field>
                    <textarea required matInput placeholder="Value" formControlName="value"></textarea>
                </mat-form-field>
            </mat-tab>
        </mat-tab-group>

        <button (click)="addBiblioRef()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add a bibliographic reference
        </button>
    </div>

    <div class="metadata-nested" formArrayName="other">
        <h2>Other</h2>

        <mat-tab-group>
            <mat-tab *ngFor="let other of other.controls; index as i" [formGroup]="other">
                <ng-template mat-tab-label>
                    <p>{{ getTabLabel(other.value.description, 'other') }}</p>
                    <button class="metadata-tab-delete-button" mat-button color="warn"
                            (click)="removeOther(i)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </ng-template>

                <mat-form-field>
                    <input required matInput placeholder="Description"
                           formControlName="description">
                </mat-form-field>
                <mat-form-field>
                    <input required matInput placeholder="Value" formControlName="value">
                </mat-form-field>
            </mat-tab>
        </mat-tab-group>

        <button (click)="addOther()" mat-button color="primary">
            <mat-icon>add_circle</mat-icon> Add other information
        </button>
    </div>

    <div class="metadata-nested external-file-input-field">
        <div>
            <h2>Metadata files</h2>

            <p>If you have files containing information related to this object, add them below.</p>
        </div>

        <div class="external-file-input">
            <button mat-raised-button (click)="fileInput.click()">Choose files</button>
            <input hidden #fileInput type="file" multiple (change)="handleFileInput(fileInput)" />
        </div>

        <mat-list>
            <mat-list-item *ngFor="let file of metadata_files.value">{{ file.file_name }} - {{ (file.file_size / 1024 / 1024).toFixed(2) }}MB</mat-list-item>
        </mat-list>
    </div>

    <ng-container *ngIf="!isPhysical">
        <div class="metadata-nested" formArrayName="phyObjs">
            <h2>Physical Objects</h2>

            <mat-tab-group>
                <mat-tab *ngFor="let phyObj of phyObjs.controls; index as i" [formGroup]="phyObjs">
                    <ng-template mat-tab-label>
                        <p>{{ getTabLabel(phyObj.value.title, 'physical entity') }}</p>
                        <button class="metadata-tab-delete-button" mat-button color="warn"
                                (click)="removePhysicalEntity(i)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </ng-template>

                    <app-entity [isPhysical]="true" [(entity)]="phyObj"></app-entity>
                </mat-tab>
            </mat-tab-group>
            <button (click)="addPhysicalEntity()" mat-button color="primary">
                <mat-icon>add_circle</mat-icon> Add a physical object
            </button>
        </div>
    </ng-container>
</form>
